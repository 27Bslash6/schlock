# Category: Credential Theft
# Risk Levels: BLOCKED
# Description: Commands that expose credentials and sensitive data

rules:
  - name: credential_exposure
    description: Exposing credentials is a security breach
    risk_level: BLOCKED
    patterns: ['cat\s+.{0,200}\.env', 'cat\s+.{0,200}id_rsa', 'echo.{0,200}password']
    alternatives: ["Use secure secret management"]

  - name: extended_credential_exposure
    description: Accessing additional credential files beyond .env and id_rsa
    risk_level: BLOCKED
    patterns: ['cat\s+.{0,200}\.aws/(credentials|config)', 'cat\s+.{0,200}\.ssh/(config|known_hosts|authorized_keys)', 'cat\s+.{0,200}\.npmrc', 'cat\s+.{0,200}\.netrc', 'cat\s+.{0,200}\.docker/config', 'cat\s+.{0,200}\.kube/config', 'cat\s+.{0,200}\.git-credentials', 'cat\s+.{0,200}\.pypirc', 'echo.{0,200}(AWS_SECRET|API_KEY|TOKEN|PASSWORD|PRIVATE_KEY)', 'printf.{0,200}(AWS_SECRET|API_KEY|TOKEN|PASSWORD|PRIVATE_KEY)']
    alternatives: ["Use proper secret management tools", "Never expose credentials"]

  - name: hardcoded_secrets
    description: Prevent hardcoding secrets
    risk_level: BLOCKED
    patterns: ['export\s+AWS_SECRET', 'export\s+.{0,100}_KEY=', 'export\s+.{0,100}_TOKEN=', "echo.{0,200}['\"].{0,100}key.{0,100}['\"]\\s*>"]
    alternatives: ["Use environment files", "Use secrets manager", "Use vault"]

  # ============================================================
  # SSH Key Exfiltration (P0 Critical Gap)
  # ============================================================

  - name: ssh_key_exfiltration
    description: SSH private keys enable persistent unauthorized access
    risk_level: BLOCKED
    patterns:
      # Reading SSH keys with various tools (beyond just cat)
      - '(cat|less|head|tail|more|strings|base64|xxd|od)\s+[^;|&]*\.ssh/(id_rsa|id_ed25519|id_ecdsa|id_dsa|identity)'
      - '(cat|less|head|tail|more|strings|base64|xxd|od)\s+[^;|&]*\.ssh/id_[a-z0-9]+'
      # Copying SSH keys
      - '(cp|mv|scp|rsync)\s+[^;|&]*\.ssh/(id_rsa|id_ed25519|id_ecdsa|id_dsa|identity)'
      - '(cp|mv|scp|rsync)\s+[^;|&]*\.ssh/id_[a-z0-9]+[^;|&]*/tmp/'
      # Archiving SSH keys
      - '(tar|zip|gzip)\s+[^;|&]*\.ssh/(id_rsa|id_ed25519|id_ecdsa|id_dsa|identity)'
      - '(tar|zip)\s+[^;|&]*\.ssh/[^;|&]*\|'
      # Grep/search through SSH keys (extraction)
      - 'grep\s+[^;|&]*\.ssh/(id_rsa|id_ed25519|id_ecdsa|id_dsa)'
      # OpenSSL operations on SSH keys
      - 'openssl\s+(rsa|ec|dsa|pkey)\s+[^;|&]*\.ssh/'
    alternatives:
      - "SSH keys should never be copied or transmitted"
      - "Use ssh-agent for key management"
      - "Generate new keys on target systems"

  - name: ssh_key_manipulation
    description: SSH key generation in suspicious locations or with weak settings
    risk_level: HIGH
    patterns:
      # Key generation to /tmp or /dev/shm (exfil staging)
      - 'ssh-keygen\s+[^;|&]*-f\s+/tmp/'
      - 'ssh-keygen\s+[^;|&]*-f\s+/dev/shm/'
      - 'ssh-keygen\s+[^;|&]*-f\s+/var/tmp/'
      # Key generation with empty passphrase
      - 'ssh-keygen\s+[^;|&]*-N\s+[''"][''"]'
      - 'ssh-keygen\s+[^;|&]*-N\s+""'
      # ssh-keyscan (reconnaissance)
      - 'ssh-keyscan\s+'
      # Extract public key from private (could indicate key theft)
      - 'ssh-keygen\s+[^;|&]*-y\s+[^;|&]*-f'
    alternatives:
      - "Generate keys in proper locations with passphrases"
      - "Use ssh-keyscan only for known hosts setup"

  - name: ssh_agent_abuse
    description: SSH agent manipulation can expose loaded keys
    risk_level: BLOCKED
    patterns:
      # List all loaded keys
      - 'ssh-add\s+-L'
      - 'ssh-add\s+--list'
      # SSH_AUTH_SOCK manipulation/exfil
      - 'echo\s+[^;|&]*SSH_AUTH_SOCK'
      - 'cat\s+[^;|&]*SSH_AUTH_SOCK'
      - 'export\s+SSH_AUTH_SOCK='
      # Agent forwarding abuse
      - 'ssh\s+[^;|&]*-A\s+[^;|&]*-o\s+ForwardAgent'
    alternatives:
      - "SSH agent keys are sensitive"
      - "Avoid agent forwarding to untrusted hosts"

  # ============================================================
  # GAP-002: Git Credential Theft
  # ============================================================

  - name: git_credential_theft
    description: Git credential helpers and configs contain stored passwords
    risk_level: BLOCKED
    patterns:
      # Git credential cache/helper commands
      - 'git\s+credential\s+(fill|approve|reject)'
      - 'git\s+credential-cache\s+exit'
      # Config extraction with credential info
      - 'git\s+config[^;|&]*(credential|insteadOf)'
      - 'git\s+config\s+--list[^;|&]*\|\s*grep'
      # Remote URL extraction (may contain tokens)
      - 'git\s+remote\s+-v\s*\|\s*grep\s+https'
      - 'git\s+config\s+--get\s+remote[^;|&]*url'
      # GitHub CLI tokens
      - '(cat|less|grep|strings)\s+[^;|&]*\.config/gh/hosts\.yml'
      - 'gh\s+auth\s+token'
    alternatives:
      - "Use credential helpers securely"
      - "Never expose git credentials"

  - name: ssh_known_hosts_manipulation
    description: Removing known hosts enables MITM attacks
    risk_level: HIGH
    patterns:
      # Remove all known hosts (wildcard)
      - 'ssh-keygen\s+-R\s+\*'
      - 'ssh-keygen\s+-R\s+\.'
      # Wipe known hosts file
      - '>\s*~?/?\.ssh/known_hosts'
      - 'rm\s+[^;|&]*\.ssh/known_hosts'
      - 'truncate\s+[^;|&]*\.ssh/known_hosts'
    alternatives:
      - "Removing known hosts weakens SSH security"
      - "Use ssh-keygen -R for specific hosts only"

  # ============================================================
  # GAP-003: Environment Variable Credential Extraction
  # ============================================================

  - name: environment_credential_extraction
    description: Environment variables often contain API keys and tokens
    risk_level: BLOCKED
    patterns:
      # Dump all environment variables
      - '^\s*env\s*$'
      - '^\s*printenv\s*$'
      - '^\s*export\s+-p\s*$'
      # Grep environment for credentials
      - '(env|printenv)\s*\|\s*grep'
      - 'export\s+-p\s*\|\s*grep'
      # Extract specific credential variables
      - 'echo\s+\$[A-Z_]*(KEY|TOKEN|SECRET|PASSWORD|CREDENTIAL)'
      - 'printenv\s+[A-Z_]*(KEY|TOKEN|SECRET|PASSWORD|API)'
      # /proc environment extraction (other processes)
      - '(cat|strings|grep)\s+/proc/[0-9]+/environ'
    alternatives:
      - "Environment variables contain sensitive credentials"
      - "Use secure secret management instead"

  # ============================================================
  # GAP-005: Database Credential Files
  # ============================================================

  - name: database_credential_theft
    description: Database credential files and CLI histories contain passwords
    risk_level: BLOCKED
    patterns:
      # PostgreSQL
      - '(cat|less|grep|strings)\s+[^;|&]*\.pgpass'
      - '(cat|less|grep|strings)\s+[^;|&]*pg_service\.conf'
      # MySQL
      - '(cat|less|grep|strings)\s+[^;|&]*\.my\.cnf'
      - '(cat|less|grep|strings)\s+[^;|&]*\.mysql_history'
      # MongoDB
      - '(cat|less|grep|strings)\s+[^;|&]*\.mongorc\.js'
      - 'mongo[^;|&]*--eval[^;|&]*getUsers'
      # Redis
      - '(cat|less|grep|strings)\s+[^;|&]*\.rediscli_history'
      # SQLite credential extraction
      - 'sqlite3\s+[^;|&]*\.dump[^;|&]*password'
    alternatives:
      - "Database credentials should use secure storage"
      - "Never expose database configuration files"
