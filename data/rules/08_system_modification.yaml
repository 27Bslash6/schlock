# Category: System Modification
# Risk Levels: BLOCKED, HIGH
# Description: Commands that modify critical system files and permissions

rules:
  # BLOCKED
  - name: protect_system_files
    description: Prevent modifications to system files
    risk_level: BLOCKED
    patterns: ['\b(rm|mv|cp)\s+.{0,200}/(etc|sys|proc|boot|sbin|dev)/', '>\s*/(etc|sys|proc|boot|sbin)/', 'rm\s+/sbin/init', 'rm\s+/dev/', 'chmod.{0,100}/(sbin|dev|usr/lib/systemd)/', 'chmod\s+000\s+/usr/', 'mknod\s+/dev/']
    alternatives: ["Use configuration management tools", "Request system administrator access"]

  - name: recursive_permission_system_dirs
    description: Recursive permission changes on system directories destroy systems
    risk_level: BLOCKED
    patterns: ['chmod\s+(-R|--recursive)\s+[0-7]{3}\s+(\/|\/etc|\/home|\/usr|\/var|\/opt|\/srv)(\s|$)', 'chmod\s+[0-7]{3}\s+(-R|--recursive)\s+(\/|\/etc|\/home|\/usr|\/var|\/opt|\/srv)(\s|$)', 'chown\s+(-R|--recursive)\s+.{0,100}\s+(\/|\/etc|\/home|\/usr|\/var|\/opt|\/srv)(\s|$)', 'chown\s+.{0,100}\s+(-R|--recursive)\s+(\/|\/etc|\/home|\/usr|\/var|\/opt|\/srv)(\s|$)', 'find\s+/(|etc|home|usr|var)\s+.{0,200}-exec\s+(chmod|chown)']
    alternatives: ["NEVER change permissions recursively on system directories", "Target specific files only", "Use configuration management"]

  # HIGH
  - name: chmod_777
    description: Creates security vulnerability
    risk_level: HIGH
    patterns: ['chmod\s+777', 'chmod\s+-R\s+777', 'chmod\s+777.*-R', 'chmod\s+--recursive\s+777']
    alternatives: ["Use 755 or 644"]

  - name: recursive_permission_destruction
    description: Recursive permission changes can break systems
    risk_level: HIGH
    patterns: ['chmod\s+-R\s+[0-7]{3}', 'chmod\s+--recursive', 'chmod\s+[0-7]{3}.{0,50}-R', 'chown\s+-R', 'chown\s+--recursive', 'find\s+/.{0,200}-exec\s+(chmod|chown).{0,50}\{\}']
    alternatives: ["Target specific directories only", "Use configuration management", "Test in isolated environment"]

  - name: system_critical_writes
    description: Prevent writes to critical system locations
    risk_level: HIGH
    patterns: ['(?<!2)>\s*/proc/sys/', '(?<!2)>\s*/boot/', 'echo.{0,200}(?<!2)>\s*/dev/(?!null\b)', 'cat.{0,200}(?<!2)>\s*/dev/(?!null\b)']
    alternatives: ["Never write directly to system files", "Use proper system APIs", "Modify via configuration files"]

  - name: permission_manipulation_extended
    description: Additional permission and attribute manipulation commands
    risk_level: HIGH
    patterns: ['setfacl\s+.{0,100}-m\s+.{0,100}:rwx', 'setfacl\s+.{0,100}--modify', 'chattr\s+.{0,100}[-+]i', 'chattr\s+.{0,100}[-+]a', 'umask\s+0{1,3}[0-7]?', 'chmod\s+.{0,100}\+s', 'chmod\s+[24]7[0-7]{2}', 'chmod\s+.{0,100}a\+[rwx]+']
    alternatives: ["Use restrictive permissions", "Document permission changes", "Use configuration management"]

  - name: system_service_modification
    description: System configuration and startup modification
    risk_level: HIGH
    patterns: ['systemctl\s+.{0,100}(disable|mask|stop).{0,100}(firewall|apparmor|selinux|ufw|iptables)', 'update-rc\.d\s+.{0,100}(disable|remove)', 'chkconfig\s+.{0,100}off', 'crontab\s+-r', 'at\s+.{0,100}(midnight|now)', 'echo.{0,200}>>\s*/etc/cron', 'modprobe\s+.{0,100}(ip_tables|nf_|xt_)', 'insmod\s+.{0,100}\.ko', 'sysctl\s+-w\s+.{0,100}=0']
    alternatives: ["Use configuration management", "Document system changes", "Test in isolation"]

  - name: process_manipulation
    description: Process and signal manipulation
    risk_level: MEDIUM
    patterns: ['kill\s+-9\s+1(?!\d)', 'killall\s+.{0,100}(systemd|init|kernel)', 'pkill\s+.{0,100}(systemd|init|kernel)', 'nice\s+-n\s+-20', 'renice\s+.{0,100}-20']
    alternatives: ["Target specific processes", "Use proper process management", "Avoid system processes"]

  - name: mount_operations
    description: Filesystem mounting with dangerous options
    risk_level: MEDIUM
    patterns: ['mount\s+.{0,100}-o\s+.{0,100}(rw|exec|suid)', 'mount\s+.{0,100}--bind\s+/\s+', 'mount\s+.{0,100}-t\s+.{0,100}/dev/', 'umount\s+-f', 'umount\s+/']
    alternatives: ["Use proper mount points", "Document mount operations", "Use read-only where possible"]

  - name: user_management
    description: User and group modifications
    risk_level: MEDIUM
    patterns: ['useradd\s+.{0,100}-G\s+.{0,100}(sudo|wheel|admin)', 'usermod\s+.{0,100}-a\s+-G\s+.{0,100}(sudo|wheel|admin)', 'passwd\s+-d', 'passwd\s+root', 'visudo', 'echo.{0,200}>>\s*/etc/sudoers', 'adduser\s+.{0,100}--disabled-password']
    alternatives: ["Use proper user management", "Document user changes", "Use LDAP/SSO"]
