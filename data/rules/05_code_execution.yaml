# Category: Code Execution
# Risk Levels: BLOCKED, HIGH
# Description: Commands that enable arbitrary code execution

rules:
  # BLOCKED
  - name: remote_execution
    description: Downloading and executing code is dangerous - classic rootkit vector
    risk_level: BLOCKED
    patterns:
      # Common download tools piped to shell interpreters
      - '(curl|wget|fetch|aria2c|http|https).{0,200}\|\s*(bash|sh|zsh|dash|ksh|eval)'
      # Text browsers that can dump to stdout
      - '(lynx|links|elinks|w3m)\s+[^|]*(-dump|-source).{0,100}\|\s*(bash|sh|zsh|eval)'
      # Network tools receiving and executing
      - '(nc|netcat|ncat|socat).{0,200}\|\s*(bash|sh|zsh|eval)'
      # Perl LWP tools (GET, lwp-request, lwp-download)
      - '(GET|lwp-request)\s+https?://.{0,100}\|\s*(bash|sh|zsh|eval)'
      # Reverse order: shell reading from process substitution
      - '(bash|sh|zsh)\s+<\(.{0,50}(curl|wget|fetch|nc|netcat)'
    alternatives: ["Download first, inspect, then run"]

  - name: source_remote_script
    description: Sourcing or executing remote scripts is extremely dangerous
    risk_level: BLOCKED
    patterns: ['source\s+.{0,200}(https?|ftps?|ssh)://', '\.\s+.{0,200}(https?|ftps?|ssh)://', 'bash\s+<\(.{0,100}(curl|wget).{0,100}(https?|ftps?)://', 'sh\s+<\(.{0,100}(curl|wget).{0,100}(https?|ftps?)://', 'source\s+/tmp/.{0,100}\.(sh|bash)', '\.\s+/tmp/.{0,100}\.(sh|bash)']
    alternatives: ["Download first, inspect, then run", "Use package managers"]

  - name: command_substitution_dangerous
    description: Command substitution with dangerous commands executes code
    risk_level: BLOCKED
    patterns: ['\$\([^)]{0,200}\b(rm|sudo|dd|mkfs|chmod|eval|exec)', '`[^`]{0,200}\b(rm|sudo|dd|mkfs|chmod|eval|exec)']
    alternatives: ["Avoid dynamic command execution", "Use explicit commands instead", "Run commands directly without substitution"]

  # BLOCKED - Arbitrary code execution
  - name: eval_exec
    description: Executes arbitrary code - can run anything
    risk_level: BLOCKED
    patterns: ['^\s*eval\s+', '\|\s*eval\s+', ';\s*eval\s+', '&&\s*eval\s+', '^\s*exec\s+', '\|\s*exec\s+', ';\s*exec\s+', '&&\s*exec\s+']
    alternatives: ["Parse and validate input", "Avoid dynamic code execution"]

  # HIGH

  - name: find_exec_dangerous
    description: Find with dangerous exec commands
    risk_level: HIGH
    patterns: ['find.{0,200}-exec\s+(rm|sh|bash|python|perl|ruby|node|curl|wget|dd|mkfs|fdisk|mount)', 'find.{0,200}-exec.{0,100}\|.{0,50}bash', 'find.{0,200}-exec.{0,100}\|.{0,50}sh']
    alternatives: ["Review what will be executed", "Use xargs instead", "Test on small subset first"]

  - name: interpreter_dangerous_execution
    description: Scripting language arbitrary code execution with dangerous functions
    risk_level: HIGH
    patterns: ["python[23]?\\s+-c\\s+[\"']?.{0,200}(os\\.system|subprocess\\.(call|run|Popen)|exec|eval|compile|__import__)", "perl\\s+-[eE]\\s+[\"']?.{0,200}(system|exec|eval|`|qx)", "ruby\\s+-e\\s+[\"']?.{0,200}(system|exec|eval|%x|`)", "node\\s+-e\\s+[\"']?.{0,200}(exec|eval|require.{0,30}child_process)", "php\\s+-r\\s+[\"']?.{0,200}(system|exec|eval|shell_exec|passthru|`)", "awk.{0,200}BEGIN\\s*\\{.{0,100}(system|getline.{0,30}\\|)", "sed\\s+.{0,100}e\\s+[\"']?.{0,100}(sh|bash|rm|chmod)"]
    alternatives: ["Avoid dynamic code execution", "Use proper scripts instead of one-liners"]

  - name: xargs_dangerous_commands
    description: xargs with destructive commands can affect many files
    risk_level: HIGH
    patterns: ['xargs\s+.{0,100}(rm|sudo|chmod|chown|dd|mkfs|shred)', 'xargs\s+.{0,100}-I.{1,10}\s+(rm|sudo|chmod|chown|dd|mkfs)', 'parallel\s+.{0,100}(rm|sudo|chmod|chown|dd|mkfs)', 'find.{0,200}\|\s*xargs\s+(rm|chmod|chown)']
    alternatives: ["Review input before piping to xargs", "Use -p flag for confirmation", "Test with echo first"]

  - name: alternate_shells_and_escapes
    description: Alternative shell invocations and escape sequences
    risk_level: HIGH
    patterns: ["sh\\s+-c\\s+[\"']?.{0,200}(rm|dd|mkfs|chmod|sudo)", "bash\\s+-c\\s+[\"']?.{0,200}(rm|dd|mkfs|chmod|sudo)", "zsh\\s+-c\\s+[\"']?.{0,200}(rm|dd|mkfs|chmod|sudo)", 'env\s+.{0,100}(bash|sh|zsh)\s+-c', 'nohup\s+.{0,100}(rm|dd|mkfs|chmod)', 'screen\s+-dm\s+.{0,100}(bash|sh)', 'tmux\s+.{0,100}send-keys.{0,100}(rm|dd|mkfs)']
    alternatives: ["Run commands directly", "Avoid shell invocation", "Use proper job control"]

  - name: macos_script_execution
    description: macOS-specific script execution and system control
    risk_level: HIGH
    patterns: ['osascript\s+(-e|-).*', 'osascript\s+.{0,200}\.(scpt|applescript)', 'open\s+-a\s+Terminal', 'open\s+-a\s+.{0,100}--args', 'automator\s+', 'shortcuts\s+run']
    alternatives: ["Avoid scripting system automation", "Use explicit commands instead", "Review script contents first"]

  - name: macos_system_modification
    description: macOS system configuration and security modifications
    risk_level: HIGH
    patterns: ['launchctl\s+(load|unload|bootout|disable)', 'defaults\s+write\s+.{0,200}(com\.apple|NSGlobalDomain)', 'defaults\s+delete', 'dscl\s+.{0,100}(create|delete|passwd)', 'security\s+(delete-keychain|unlock-keychain|set-keychain-settings)', 'spctl\s+--master-disable', 'csrutil\s+disable', 'nvram\s+']
    alternatives: ["Use System Preferences", "Document system changes", "Require admin approval"]

  # ============================================================
  # Keychain/Credential Store Theft (P0 Critical Gap)
  # ============================================================

  - name: macos_keychain_theft
    description: macOS Keychain contains all stored passwords and certificates
    risk_level: BLOCKED
    patterns:
      # Find and extract passwords
      - 'security\s+find-generic-password'
      - 'security\s+find-internet-password'
      # Dump entire keychain
      - 'security\s+dump-keychain'
      - 'security\s+dump-trust-settings'
      # Export keys/certificates
      - 'security\s+export[^;|&]*-k'
      - 'security\s+find-certificate[^;|&]*-p'
      # Show keychain info
      - 'security\s+show-keychain-info'
      # Access keychain files directly
      - '(cat|less|strings|cp|tar)\s+[^;|&]*Library/Keychains/'
      - '(cat|less|strings|cp|tar)\s+[^;|&]*\.keychain'
    alternatives:
      - "Keychain access requires explicit user consent"
      - "Use Keychain Access.app for authorized access"
      - "Never exfiltrate keychain contents"

  - name: linux_keyring_theft
    description: Linux keyring/secret storage contains stored credentials
    risk_level: BLOCKED
    patterns:
      # GNOME Keyring
      - 'secret-tool\s+lookup'
      - 'secret-tool\s+search'
      - '(cat|less|strings|cp|tar)\s+[^;|&]*\.local/share/keyrings/'
      # pass password manager
      - 'pass\s+show'
      - 'pass\s+[^;|&]*-c'
      # GPG private keys
      - '(cat|less|strings|cp|tar)\s+[^;|&]*\.gnupg/private-keys'
      - 'gpg\s+[^;|&]*--export-secret-keys'
      # KWallet
      - 'kwallet-query\s+'
      - '(cat|less|strings|cp|tar)\s+[^;|&]*\.local/share/kwalletd/'
    alternatives:
      - "Credential store access requires explicit consent"
      - "Use system tools for authorized access"

  - name: windows_script_execution
    description: Windows-specific script execution vectors
    risk_level: HIGH
    patterns: ['powershell\s+(-c|-Command|-EncodedCommand|-e)', 'pwsh\s+(-c|-Command)', 'cmd\s+/c', 'cmd\.exe\s+/c', 'wscript\s+', 'cscript\s+', 'mshta\s+', 'rundll32\s+', 'regsvr32\s+/s', 'certutil\s+.{0,100}(-decode|-urlcache)']
    alternatives: ["Use explicit commands", "Avoid encoded commands", "Review script contents"]

  - name: linux_dbus_execution
    description: Linux D-Bus and desktop automation
    risk_level: MEDIUM
    patterns: ['dbus-send\s+.{0,200}(Exec|Launch|Run)', 'gdbus\s+call\s+', 'qdbus\s+.{0,100}(exec|run)', 'xdotool\s+', 'xte\s+', 'expect\s+-c']
    alternatives: ["Use direct commands", "Avoid automation scripts", "Review automation carefully"]

  # ============================================================
  # Obfuscation Detection (P0 Critical Gap)
  # ============================================================

  # BLOCKED - IFS manipulation
  - name: ifs_obfuscation
    description: IFS variable manipulation to bypass space filtering
    risk_level: BLOCKED
    patterns:
      # ${IFS} usage (bypasses space detection)
      - '\$\{IFS\}'
      - '\$IFS'
      # IFS override (changing field separator)
      - '\bIFS\s*=\s*[^;\s]+'
      # IFS parameter expansion variants
      - '\$\{IFS[^}]*\}'
    alternatives:
      - "Use explicit spaces - IFS obfuscation indicates malicious intent"
      - "IFS manipulation is a known bypass technique"

  # BLOCKED - Base64 decode to shell execution
  - name: base64_shell_execution
    description: Base64 decoding piped to shell execution
    risk_level: BLOCKED
    patterns:
      # base64 -d piped to shell
      - 'base64\s+(-d|--decode)[^;|&]*\|\s*(bash|sh|zsh|eval)'
      - '(bash|sh|zsh).*<<<.*\$\(base64\s+(-d|--decode)'
      - 'echo\s+[A-Za-z0-9+/=]{20,}[^;|&]*\|\s*base64\s+(-d|--decode)[^;|&]*\|\s*(bash|sh)'
      # Openssl base64 decode to shell
      - 'openssl\s+(base64|enc)[^;|&]*-d[^;|&]*\|\s*(bash|sh)'
      # Python base64 decode to execution
      - "python[23]?[^;|&]*base64[^;|&]*decode[^;|&]*exec"
    alternatives:
      - "Never pipe decoded content to shell interpreters"
      - "Download, inspect, then run - not decode and execute"

  # HIGH - Hex/octal encoding in commands
  - name: hex_octal_encoding
    description: Hex or octal encoding to obfuscate dangerous commands
    risk_level: HIGH
    patterns:
      # Hex escapes in $'' syntax
      - "\\$'[^']*\\\\x[0-9a-fA-F]{2}"
      # Octal escapes in $'' syntax
      - "\\$'[^']*\\\\[0-7]{3}"
      # echo -e with hex escapes
      - 'echo\s+-e\s+[^;|&]*\\x[0-9a-fA-F]{2}'
      # printf with hex/octal
      - 'printf\s+[^;|&]*\\x[0-9a-fA-F]{2}'
      # xxd reverse (decode hex)
      - 'xxd\s+(-r|--reverse)'
    alternatives:
      - "Avoid encoded commands - encoding indicates obfuscation"
      - "Use explicit commands for transparency"

  # HIGH - Brace expansion for command obfuscation
  - name: brace_expansion_obfuscation
    description: Brace expansion to bypass command/argument detection
    risk_level: HIGH
    patterns:
      # Brace expansion with dangerous commands
      - '\{[^}]*,\s*(rm|dd|mkfs|chmod|sudo|eval|sh|bash)[,\}]'
      - '\{[^}]*,\s*-[rf]+\s*,\s*/[,\}]'
      # Command as first brace element (including cat for /etc/passwd access)
      - '\{(rm|dd|mkfs|chmod|sudo|cat|curl|wget),\s*'
      # Brace expansion with sensitive paths
      - '\{[^}]*,\s*/etc/(passwd|shadow|sudoers|hosts)[,\}]'
      - '\{[^}]*,\s*~?/\.(ssh|aws|gnupg|config)[,\}]'
    alternatives:
      - "Use explicit commands without brace expansion"
      - "Brace expansion obfuscation indicates evasion attempt"

  # HIGH - Variable substring obfuscation
  - name: variable_substring_obfuscation
    description: Variable substring expansion to construct dangerous paths
    risk_level: HIGH
    patterns:
      # ${VAR:0:1} style substring extraction
      - '\$\{[A-Za-z_][A-Za-z0-9_]*:[0-9]+:[0-9]+\}'
      # ${VAR:offset} style
      - '\$\{[A-Za-z_][A-Za-z0-9_]*:[0-9]+\}'
      # Multiple substring extractions (path construction)
      - '\$\{[^}]+:[0-9]+:[0-9]+\}[^;|&]*\$\{[^}]+:[0-9]+:[0-9]+\}'
    alternatives:
      - "Use explicit paths - variable substring extraction indicates evasion"
      - "Variable obfuscation is a known bypass technique"

  # HIGH - Glob pattern obfuscation
  - name: glob_obfuscation
    description: Glob patterns obfuscating command names or paths
    risk_level: HIGH
    patterns:
      # /???/??t pattern (matches /bin/cat, etc.)
      - '/\?\?\?/\?\?[a-z]'
      # /???/???/r[m] pattern (matches /usr/bin/rm with character class)
      - '/\?\?\?/\?\?\?/[a-z]\[[a-z]\]'
      # Character class in command name (e.g., r[m], c[a]t)
      - '/[a-z]+/[a-z]*\[[a-z]\][a-z]*'
      # Multiple ? wildcards obfuscating paths
      - '/\?\?\?/\?\?\?/[a-z]+'
      # Wildcard in command position
      - '^\s*/\*/[a-z]+'
    alternatives:
      - "Use explicit paths - glob obfuscation indicates evasion"
      - "Glob patterns in command names are suspicious"

  # HIGH - Unicode/homoglyph obfuscation
  - name: unicode_homoglyph_obfuscation
    description: Non-ASCII characters that look like ASCII to evade detection
    risk_level: HIGH
    patterns:
      # Cyrillic letters that look like Latin (а=a, е=e, о=o, с=c, р=p, м=m, etc.)
      - '[аеосрухіјм]'
      # Fullwidth ASCII variants (ｒｍ looks like rm)
      - '[Ａ-Ｚａ-ｚ]'
      # Greek letters that look like Latin (α, β, ε, ο, etc.)
      - '[αβεορστυ]'
      # Zero-width characters (invisible, used to break pattern matching)
      - '[​‌‍﻿]'
      # Non-breaking spaces and other space-like chars (U+00A0, U+2000, U+2003, U+2007, U+202F, U+205F, U+3000)
      - '[      　]'
      # Combining characters (diacritics that can alter appearance)
      - '[̀-ͯ]'
    alternatives:
      - "Use only ASCII characters in commands"
      - "Unicode lookalikes indicate deliberate obfuscation"
      - "Non-ASCII in shell commands is highly suspicious"
